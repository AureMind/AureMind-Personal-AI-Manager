{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>{% block title %}Personal Manager Notes{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'notes/style.css' %}">
  <link rel="shortcut icon" href="{% static 'notes/Auremind Icon.png' %}" type="image/x-icon">
  <link rel="icon" href="{% static 'notes/Auremind Icon.png' %}" type="image/x-icon">
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="{% url 'notes:dashboard' %}">
      <img src="{% static 'notes/Auremind Logo.png' %}" alt="Auremind Logo" class="navbar-logo">
    </a>
    
    {% if user.is_authenticated %}
      <ul class="nav nav-items">
        <li class="nav-item"><a class="nav-link" href="{% url 'notes:dashboard' %}">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'notes:note' %}">Notes</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'notes:task' %}">Tasks</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'notes:calendar' %}">Calendar</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'notes:chat' %}">AI Chat</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'notes:about' %}">About</a></li>
      </ul>
    {% endif %}

      <div class="ms-auto d-flex align-items-center">
      {% if user.is_authenticated %}
        <div class="search-container position-relative me-3">
          <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Search notes..." autocomplete="off">
          <div id="search-results" class="dropdown-menu position-absolute" style="display: none; width: 300px;">
              </div>
        </div>
      {% endif %}

      {% if user.is_authenticated %}
      <span class="me-2">Hi, {{ user.username }}!</span>
      <form method="post" action="{% url 'notes:logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger btn-sm">Logout</button>
      </form>
      {% else %}
      <a href="{% url 'notes:register' %}" class="btn btn-outline-success btn-sm me-2">Register</a>
      <a href="{% url 'notes:login' %}" class="btn btn-outline-primary btn-sm">Login</a>
      {% endif %}
    </div>
  </div>
</nav>
<div class="container mt-4">

  <div id="notification-container" style="position: fixed; top: 80px; right: 20px; z-index: 1050; min-width: 250px;">
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags | default:'info' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
    </div>

  {% block content %}{% endblock %}

</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- 1. LIVE SEARCH SCRIPT ---
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  const searchUrl = "{% url 'notes:search_notes' %}";

  if (searchInput) {
    searchInput.addEventListener('keyup', function() {
      const query = searchInput.value;

      if (query.length < 3) {
        searchResults.style.display = 'none';
        return;
      }

      fetch(`${searchUrl}?q=${query}`)
        .then(response => response.json())
        .then(data => {
          searchResults.innerHTML = ''; // Clear previous results

          if (data.notes && data.notes.length > 0) {
            data.notes.forEach(note => {
              const link = document.createElement('a');
              link.href = note.url;
              link.className = 'dropdown-item';
              link.textContent = note.title;
              searchResults.appendChild(link);
            });
            searchResults.style.display = 'block';
          } else {
             const noResult = document.createElement('span');
             noResult.className = 'dropdown-item text-muted';
             noResult.textContent = 'No results found';
             searchResults.appendChild(noResult);
             searchResults.style.display = 'block';
          }
        })
        .catch(error => {
          console.error('Error fetching search results:', error);
          searchResults.style.display = 'none';
        });
    });

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-container')) {
        searchResults.style.display = 'none';
      }
    });
  }

  // --- 2. NEW: DEADLINE NOTIFICATION POLLING SCRIPT ---
  const notificationContainer = document.getElementById('notification-container');
  const notificationUrl = "{% url 'notes:task_notifications' %}";

  function checkTaskNotifications() {
    fetch(notificationUrl)
      .then(response => response.json())
      .then(data => {
        if (data.tasks && data.tasks.length > 0) {
          data.tasks.forEach(task => {
            // Create the alert HTML
            const alertHTML = `
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <strong>Task Due Soon!</strong><br>
                "${task.title}" is due at ${task.due_date_str}.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            `;
            // Add the alert to the container
            notificationContainer.insertAdjacentHTML('beforeend', alertHTML);
          });
        }
      })
      .catch(error => {
        console.error('Error fetching task notifications:', error);
      });
  }

  // Check for notifications every 30 seconds (30000 milliseconds)
  // You can change this interval
 if (window.isAuthenticated) {
    setInterval(checkTaskNotifications, 30000);
    // Also check once on page load
    checkTaskNotifications();
  }

});
</script>
{% endblock %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>

<footer class="bg-light text-center text-lg-start mt-5 py-3">
  <div class="container">
    <p class="mb-0">&copy; {{ year }} Auremind. All rights reserved.</p>
    <a href="{% url 'notes:about' %}">About</a> |
    <a href="#">Contact</a> |
    <a href="#">Privacy Policy</a>
  </div>
</footer>

</html>